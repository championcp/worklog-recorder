# Sprint 3 业务规则
## Nobody Logger - 时间跟踪系统

**版本**: 1.0  
**日期**: 2025年8月5日  
**产品负责人**: Multi-Agent Development Team

---

## 1. 时间计时器业务规则

### 1.1 计时器生命周期规则

#### BR-3.1.1: 单一活跃计时器规则
- **规则**: 每个用户同时只能有一个活跃的计时器
- **业务理由**: 防止时间重复计算，确保数据准确性
- **实现**: 
  - 启动新计时器时，检查是否存在活跃计时器
  - 如存在活跃计时器，提示用户先停止当前计时器
- **异常处理**: 显示友好提示"您已有一个正在运行的计时器，请先停止当前计时器"

#### BR-3.1.2: 计时器精度规则
- **规则**: 计时器精确到秒级，显示格式为HH:MM:SS
- **业务理由**: 提供足够精度的时间跟踪，满足专业需求
- **实现**: 使用JavaScript Date对象进行精确时间计算
- **最小计时时间**: 1秒

#### BR-3.1.3: 计时器自动保存规则
- **规则**: 计时器停止时自动保存时间记录，无需用户手动确认
- **业务理由**: 简化用户操作，防止数据丢失
- **实现**: 停止计时器触发自动保存逻辑
- **失败处理**: 如保存失败，保留计时器状态并提示用户重试

### 1.2 计时器权限规则

#### BR-3.1.4: 任务权限验证规则
- **规则**: 用户只能为自己有访问权限的项目任务启动计时器
- **业务理由**: 确保数据安全和隐私
- **验证点**: 启动计时器前验证用户对任务的访问权限
- **权限来源**: 基于项目的user_id字段进行权限验证

---

## 2. 手动时间录入业务规则

### 2.1 时间输入验证规则

#### BR-3.2.1: 时间逻辑验证规则
- **规则**: 结束时间必须晚于开始时间
- **业务理由**: 确保时间记录的逻辑正确性
- **验证时机**: 
  - 前端实时验证
  - 后端API保存前验证
- **错误消息**: "结束时间必须晚于开始时间"

#### BR-3.2.2: 时间范围限制规则
- **规则**: 
  - 时间记录不能早于系统上线时间（2024年1月1日）
  - 时间记录不能晚于当前时间
  - 单次工作时间不能超过24小时
- **业务理由**: 防止数据录入错误
- **实现**: 在时间选择器中设置最小/最大值限制

#### BR-3.2.3: 工作日期规则
- **规则**: 工作日期默认为当前日期，但用户可以选择历史日期
- **业务理由**: 支持补录历史工作时间
- **限制**: 不允许选择未来日期
- **日期范围**: 支持选择过去365天内的日期

### 2.2 描述字段规则

#### BR-3.2.4: 工作描述规则
- **规则**: 
  - 工作描述为可选字段
  - 最大长度500个字符
  - 支持多行文本输入
- **业务理由**: 提供足够空间记录工作详情，同时限制数据库存储
- **验证**: 前后端同时验证字符长度

---

## 3. 数据完整性业务规则

### 3.1 任务工时更新规则

#### BR-3.3.1: 实际工时自动计算规则
- **规则**: 
  - 新增时间记录时，自动累加到任务的actual_hours字段
  - 修改时间记录时，重新计算任务的总工时
  - 删除时间记录时，从任务工时中减去相应时间
- **业务理由**: 保持任务工时数据的实时准确性
- **计算精度**: 小时数精确到小数点后2位
- **计算公式**: actual_hours = SUM(duration_seconds) / 3600

#### BR-3.3.2: 软删除规则
- **规则**: 
  - 时间记录删除采用软删除方式（is_deleted = true）
  - 软删除的记录不参与统计计算
  - 软删除的记录保留审计轨迹
- **业务理由**: 维护数据完整性，支持数据恢复和审计
- **实现**: 查询时过滤is_deleted = false的记录

### 3.2 数据同步规则

#### BR-3.3.3: 同步版本控制规则
- **规则**: 
  - 每次数据修改时，sync_version字段自动递增
  - updated_at字段自动更新为当前时间
- **业务理由**: 为未来的多设备同步功能提供基础
- **触发条件**: INSERT、UPDATE操作自动触发

---

## 4. 用户权限业务规则

### 4.1 数据访问权限规则

#### BR-3.4.1: 用户数据隔离规则
- **规则**: 
  - 用户只能查看、编辑、删除自己的时间记录
  - 用户只能为自己有权限的项目任务记录时间
  - 所有API操作必须进行用户身份验证
- **业务理由**: 确保数据安全和用户隐私
- **验证机制**: 基于JWT token的用户身份验证

#### BR-3.4.2: 项目任务权限验证规则
- **规则**: 
  - 用户只能访问自己创建的项目下的任务
  - 权限验证在每次操作时进行
  - 权限验证失败返回403 Forbidden错误
- **验证逻辑**: 
  ```sql
  SELECT t.* FROM wbs_tasks t 
  JOIN projects p ON t.project_id = p.id 
  WHERE p.user_id = ? AND t.id = ?
  ```

---

## 5. 系统性能业务规则

### 5.1 响应时间规则

#### BR-3.5.1: API响应时间规则
- **规则**: 
  - 时间记录创建/更新API响应时间 < 200ms
  - 时间统计查询响应时间 < 500ms
  - 历史记录列表查询响应时间 < 300ms
- **业务理由**: 确保良好的用户体验
- **监控**: 实施API响应时间监控

#### BR-3.5.2: 并发处理规则
- **规则**: 
  - 系统支持至少100个并发用户
  - 数据库连接池合理配置
  - 防止计时器并发冲突
- **实现**: 使用数据库事务确保数据一致性

---

## 6. 错误处理业务规则

### 6.1 输入验证规则

#### BR-3.6.1: 前端验证规则
- **规则**: 
  - 所有用户输入在提交前进行客户端验证
  - 提供实时输入验证反馈
  - 验证失败时禁用提交按钮
- **验证项**: 必填字段、数据格式、数据范围、字符长度

#### BR-3.6.2: 后端验证规则
- **规则**: 
  - 所有API接口对输入数据进行服务端验证
  - 验证失败返回400 Bad Request错误
  - 错误消息采用中文，用户友好
- **验证层级**: 参数验证 → 业务逻辑验证 → 数据持久化

### 6.2 异常处理规则

#### BR-3.6.3: 系统异常处理规则
- **规则**: 
  - 数据库操作异常不向用户暴露技术细节
  - 网络异常提供重试机制
  - 未知异常记录日志并提供通用错误消息
- **用户提示**: "系统繁忙，请稍后重试"

---

## 7. 数据迁移和兼容性规则

### 7.1 历史数据处理规则

#### BR-3.7.1: 现有任务工时兼容规则
- **规则**: 
  - 新的时间跟踪系统与现有任务管理系统兼容
  - 现有任务的actual_hours字段保持不变
  - 新增的时间记录累加到existing actual_hours
- **迁移策略**: 增量更新，不影响现有数据

#### BR-3.7.2: 数据格式兼容规则
- **规则**: 
  - 时间格式统一使用ISO 8601标准
  - 数据库字段类型与现有系统保持一致
  - API响应格式遵循现有系统约定

---

## 8. 业务规则优先级

### 高优先级 (P0) - 必须实现
- BR-3.1.1: 单一活跃计时器规则
- BR-3.2.1: 时间逻辑验证规则  
- BR-3.3.1: 实际工时自动计算规则
- BR-3.4.1: 用户数据隔离规则

### 中等优先级 (P1) - 应该实现
- BR-3.1.2: 计时器精度规则
- BR-3.2.2: 时间范围限制规则
- BR-3.3.2: 软删除规则
- BR-3.5.1: API响应时间规则

### 低优先级 (P2) - 可以实现
- BR-3.1.4: 任务权限验证规则
- BR-3.2.4: 工作描述规则
- BR-3.6.3: 系统异常处理规则

---

## 9. 业务规则测试要求

### 9.1 单元测试要求
- 每个业务规则至少包含2个正面测试用例
- 每个业务规则至少包含1个负面测试用例
- 边界条件测试覆盖率100%

### 9.2 集成测试要求
- 跨系统业务规则端到端测试
- 权限相关规则的集成测试
- 数据一致性规则验证

---

**文档状态**: 已完成  
**最后更新**: 2025年8月5日  
**相关文档**: 
- [Sprint 3 PRD](./sprint3-prd.md)
- [Sprint 3 用户故事](./sprint3-user-stories.md)
- [Sprint 3 功能规格](./sprint3-feature-specifications.md)